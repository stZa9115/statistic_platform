<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ANOVA 檢定工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../config.js"></script>
</head>

<body class="bg-yellow-100 p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-xl font-bold mb-4">ANOVA 檢定工具</h1>

    <div class="flex space-x-4 mb-4">
      <button id="addBlock"
        class="bg-blue-500 text-white px-4 py-2 rounded">
        + 新增檢定
      </button>

      <button id="runAll"
        class="bg-green-500 text-white px-4 py-2 rounded">
        ▶ 一鍵執行全部
      </button>

      <button class="bg-purple-500 text-white px-4 py-2 rounded">
        <a href="../sample/ANOVA_example.xlsx" download>下載範例檔案</a>
      </button>

      <button id="downloadZip"
        class="bg-indigo-600 text-white px-4 py-2 rounded">
        下載全部結果 (ZIP)
      </button>
    </div>

    <div id="blocksContainer"></div>
  </div>

  <!-- ================= Block Template ================= -->
  <template id="blockTemplate">
    <div class="bg-white shadow-lg rounded-2xl p-6 mb-6 border border-gray-300 relative">

      <button type="button"
        class="deleteBlock absolute top-2 right-2
               bg-red-500 text-white w-8 h-8
               flex items-center justify-center
               rounded-full hover:bg-red-700 font-bold text-lg">
        ✕
      </button>

      <form class="uploadForm flex items-center space-x-4 mb-4">
        <input type="file" class="fileInput border p-2 rounded" required>
        <a class="downloadLink hidden bg-purple-500 text-white px-4 py-2 rounded">
          下載結果
        </a>
      </form>

      <table class="table-auto border-collapse border border-gray-400 w-full text-center text-sm">
        <tbody class="resultTable">
          <tr>
            <td class="p-4 text-gray-500">
              尚無結果
            </td>
          </tr>
        </tbody>
      </table>

    </div>
  </template>

  <!-- ================= Script ================= -->
  <script>
    const blocksContainer = document.getElementById("blocksContainer");
    const blockTemplate = document.getElementById("blockTemplate");
    const { BASE_URL, ENDPOINTS } = window.API_CONFIG;

    let blocks = [];

    function addBlock() {
      const clone = blockTemplate.content.cloneNode(true);
      const block = clone.querySelector("div");

      const fileInput = block.querySelector(".fileInput");
      const resultTable = block.querySelector(".resultTable");
      const downloadLink = block.querySelector(".downloadLink");
      const deleteBtn = block.querySelector(".deleteBlock");

      deleteBtn.addEventListener("click", () => {
        block.remove();
        blocks = blocks.filter(b => b.block !== block);
      });

      blocks.push({
        block,
        fileInput,
        resultTable,
        downloadLink,
        task_id: null
      });

      blocksContainer.appendChild(block);
    }

    async function runAll() {
      for (const block of blocks) {
        const file = block.fileInput.files[0];
        const table = block.resultTable;

        table.innerHTML = "";

        if (!file) {
          table.innerHTML = `
            <tr>
              <td class="p-3 text-yellow-600">
                未上傳檔案，已略過
              </td>
            </tr>`;
          continue;
        }

        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch(
          `${BASE_URL}${ENDPOINTS.anova}`,
          {
            method: "POST",
            body: formData
          }
        );

        const data = await res.json();
        console.log("ANOVA response:", data);

        if (data.error) {
          table.innerHTML = `
            <tr>
              <td class="p-3 text-red-500">${data.error}</td>
            </tr>`;
          continue;
        }

        block.task_id = data.task_id;

        // ================= Render Sections =================
        data.sections.forEach(section => {

          // Section title
          const titleRow = document.createElement("tr");
          titleRow.innerHTML = `
            <td colspan="${section.columns.length}"
                class="bg-gray-200 font-bold text-left px-3 py-2">
              ${section.title}
            </td>`;
          table.appendChild(titleRow);

          // Header row
          const headerRow = document.createElement("tr");
          section.columns.forEach(col => {
            const th = document.createElement("th");
            th.className = "border border-gray-400 px-2 py-1 bg-gray-100";
            th.textContent = col;
            headerRow.appendChild(th);
          });
          table.appendChild(headerRow);

          // Data rows
          section.data.forEach(row => {
            const tr = document.createElement("tr");
            section.columns.forEach(col => {
              const td = document.createElement("td");
              td.className = "border border-gray-400 px-2 py-1";
              td.textContent = row[col];
              tr.appendChild(td);
            });
            table.appendChild(tr);
          });

        });

        // Download link
        block.downloadLink.classList.remove("hidden");
        block.downloadLink.href =
          `${BASE_URL}${ENDPOINTS.download}${block.task_id}`;
      }
    }

    // ZIP download
    document.getElementById("downloadZip").addEventListener("click", async () => {
      const taskIds = blocks
        .map(b => b.task_id)
        .filter(id => id !== null);

      if (taskIds.length === 0) {
        alert("尚無可下載的結果");
        return;
      }

      const res = await fetch(
        `${BASE_URL}${ENDPOINTS.downloadZip}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(taskIds)
        }
      );

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "ANOVA.zip";
      a.click();

      URL.revokeObjectURL(url);
    });

    // Init
    addBlock();
    document.getElementById("addBlock").addEventListener("click", addBlock);
    document.getElementById("runAll").addEventListener("click", runAll);
  </script>
</body>
</html>
